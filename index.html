<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Calls Proof</title>
  </head>
  <body>
    <h1>Room Signaling Proof</h1>
    <pre id="log"></pre>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
  const log = (msg) => {
    document.getElementById("log").textContent += msg + "\n";
  };

  const ROOM_ID = "test-room";

  const socket = io("https://calls-proof-backend.onrender.com", {
    transports: ["websocket"],
  });

  let pc;

  socket.on("connect", async () => {
    log("connected: " + socket.id);

    socket.emit("room:join", { room: ROOM_ID });

    pc = new RTCPeerConnection();

    // log ICE candidates (important for later)
    pc.onicecandidate = (e) => {
      if (e.candidate) {
        socket.emit("signal", {
          room: ROOM_ID,
          data: { type: "ice", candidate: e.candidate },
        });
      }
    };

    // receive remote audio
    pc.ontrack = (e) => {
      log("remote audio received");
      const audio = document.createElement("audio");
      audio.srcObject = e.streams[0];
      audio.autoplay = true;
      document.body.appendChild(audio);
    };

    // get mic access
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    stream.getTracks().forEach((track) => pc.addTrack(track, stream));

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    socket.emit("signal", {
      room: ROOM_ID,
      data: { type: "offer", sdp: offer },
    });

    log("offer sent");
  });

  socket.on("signal", async ({ from, data }) => {
    if (!pc) return;

    if (data.type === "offer") {
      log("offer received from " + from);

      await pc.setRemoteDescription(data.sdp);
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);

      socket.emit("signal", {
        room: ROOM_ID,
        data: { type: "answer", sdp: answer },
      });

      log("answer sent");
    }

    if (data.type === "answer") {
      log("answer received");
      await pc.setRemoteDescription(data.sdp);
    }

    if (data.type === "ice") {
      await pc.addIceCandidate(data.candidate);
    }
  });
</script>
  </body>
</html>
